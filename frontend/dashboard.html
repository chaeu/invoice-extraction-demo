<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Invoice Extraction Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+CiAgPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iIzAwMzM2NiIvPgogIDxyZWN0IHg9IjciIHk9IjgiIHdpZHRoPSIxMiIgaGVpZ2h0PSIyIiByeD0iMSIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuOSIvPgogIDxyZWN0IHg9IjciIHk9IjEzIiB3aWR0aD0iMTgiIGhlaWdodD0iMiIgcng9IjEiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4KICA8cmVjdCB4PSI3IiB5PSIxOCIgd2lkdGg9IjE0IiBoZWlnaHQ9IjIiIHJ4PSIxIiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC45Ii8+CiAgPGNpcmNsZSBjeD0iMjQiIGN5PSIyMiIgcj0iNSIgZmlsbD0iIzFhN2E0YSIvPgogIDxwYXRoIGQ9Ik0yMS41IDIybDIgMiAzLjUtMy41IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBmaWxsPSJub25lIi8+Cjwvc3ZnPg==">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #fafafa;
      --surface:   #ffffff;
      --surface2:  #f4f6f9;
      --accent:    #2563eb;
      --accent-lt: #eff6ff;
      --green:     #16a34a;
      --green-lt:  #f0fdf4;
      --amber:     #d97706;
      --amber-lt:  #fffbeb;
      --red:       #dc2626;
      --red-lt:    #fef2f2;
      --border:    #e5e9f0;
      --border2:   #d0d7e3;
      --text:      #111827;
      --text-mid:  #4b5563;
      --text-dim:  #9ca3af;
      --mono:      "JetBrains Mono", monospace;
      --sans:      "Inter", sans-serif;
      --radius:    10px;
      --shadow:    0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      font-size: 13px;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      flex-shrink: 0;
      position: relative;
      z-index: 10;
    }

    .header-left { display: flex; align-items: center; gap: 1rem; }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .header-icon {
      width: 28px; height: 28px;
      background: var(--accent);
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .header-title {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .header-sep { width: 1px; height: 18px; background: var(--border2); }
    .header-tag {
      font-size: 0.72rem;
      color: var(--text-dim);
      font-weight: 400;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }


    /* â”€â”€ Layout â”€â”€ */
    #workspace { flex: 1; display: flex; overflow: hidden; }

    /* â”€â”€ PDF column â”€â”€ */
    #pdf-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      overflow: hidden;
      background: var(--surface);
    }

    #upload-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.6rem 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    #drop-zone {
      flex: 1;
      min-width: 0;
      border: 1.5px dashed var(--border2);
      border-radius: 7px;
      padding: 0.38rem 0.7rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 0.78rem;
      color: var(--text-dim);
      background: var(--surface2);
    }
    #drop-zone:hover { border-color: var(--accent); background: var(--accent-lt); color: var(--accent); }
    #drop-zone.drag-over { border-color: var(--accent); background: var(--accent-lt); }
    #drop-zone input { display: none; }
    #file-name {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .upload-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }

    select {
      font-family: var(--mono);
      font-size: 0.68rem;
      padding: 0.32rem 0.5rem;
      border: 1px solid var(--border2);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text-mid);
      cursor: pointer;
      outline: none;
      transition: border-color 0.15s;
    }
    select:hover, select:focus { border-color: var(--accent); color: var(--text); }

    .btn {
      padding: 0.35rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-size: 0.75rem;
      font-family: var(--sans);
      font-weight: 500;
      letter-spacing: -0.01em;
      white-space: nowrap;
      transition: all 0.15s;
      box-shadow: 0 1px 2px rgba(37,99,235,0.3);
    }
    .btn:hover { background: #1d4ed8; }

    .btn:disabled { background: var(--border2); color: var(--text-dim); cursor: not-allowed; box-shadow: none; transform: none; }

    #status { font-size: 0.72rem; color: var(--text-dim); white-space: nowrap; }

    /* â”€â”€ PDF viewer â”€â”€ */
    #pdf-panel {
      flex: 1;
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      min-height: 0;
    }
    #pdf-panel .empty { color: var(--text-dim); font-size: 0.8rem; text-align: center; }
    #pdf-panel .empty .icon { font-size: 2.5rem; margin-bottom: 0.6rem; opacity: 0.35; }
    #pdf-embed { width: 100%; height: 100%; border: none; display: none; }

    /* â”€â”€ Data panel â”€â”€ */
    #data-panel {
      flex: 1.6;
      overflow-y: scroll;
      padding: 1.1rem;
      display: block;
      background: var(--bg);
      scrollbar-width: thin;
      scrollbar-color: var(--border2) transparent;
    }
    #data-panel > * { margin-bottom: 0.7rem; }
    #data-panel > *:last-child { margin-bottom: 0; }
    #data-panel.empty-state {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      font-size: 0.82rem;
    }

    /* â”€â”€ Cards â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.55rem 0.9rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }
    .card-title {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-mid);
    }

    .pdf-type-badge {
      font-family: var(--mono);
      font-size: 0.6rem;
      font-weight: 500;
      padding: 0.12rem 0.45rem;
      border-radius: 4px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .badge-digital     { background: var(--green-lt); color: var(--green); border: 1px solid #bbf7d0; }
    .badge-scan        { background: var(--amber-lt); color: var(--amber); border: 1px solid #fde68a; }
    .badge-handwritten { background: #faf5ff; color: #7c3aed; border: 1px solid #ddd6fe; }

    .card-body { padding: 0.8rem 0.9rem; }
    .fields { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem 1.5rem; }
    .fields.three { grid-template-columns: 1fr 1fr 1fr; }
    .field label {
      display: block;
      font-size: 0.63rem;
      font-weight: 500;
      color: var(--text-dim);
      margin-bottom: 0.18rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .field span { font-size: 0.83rem; font-weight: 400; color: var(--text); }
    .field.required label::after { content: " *"; color: var(--amber); font-weight: 700; }
    .field.flagged span { color: var(--red); }
    .field.flagged label { color: var(--red); opacity: 0.8; }

    .divider { height: 1px; background: var(--border); margin: 0.65rem 0; }

    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th {
      padding: 0.38rem 0.65rem;
      font-size: 0.62rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border);
      text-align: left;
      background: var(--surface2);
    }
    td { padding: 0.4rem 0.65rem; border-bottom: 1px solid var(--bg); color: var(--text-mid); }
    
    tr:last-child td { border-bottom: none; }
    .total-row td {
      font-weight: 600;
      border-top: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
    }
    .amount { text-align: right; font-family: var(--mono); font-size: 0.75rem; }

    .req-legend { font-size: 0.63rem; color: var(--text-dim); }
    .req-legend span { color: var(--amber); }

    /* â”€â”€ Validation sidebar â”€â”€ */
    #val-panel {
      width: 272px;
      flex-shrink: 0;
      border-left: 1px solid var(--border);
      background: var(--surface);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      scrollbar-width: thin;
      scrollbar-color: var(--border2) transparent;
    }

    .val-main-header {
      padding: 0.65rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-mid);
      background: var(--surface2);
      flex-shrink: 0;
    }

    .val-section-block {
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .val-subheading {
      display: flex;
      flex-direction: column;
      gap: 0.38rem;
      padding: 0.55rem 1rem 0.5rem;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }
    .val-subheading-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .val-subheading-title {
      font-size: 0.63rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-mid);
    }
    .val-subheading-pct {
      font-family: var(--mono);
      font-size: 0.65rem;
      font-weight: 500;
    }

    .val-section-bar {
      height: 3px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
    }
    .val-section-bar-fill {
      height: 100%;
      border-radius: 99px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .val-flags {
      padding: 0.5rem 1rem 0.55rem;
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .flag-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.73rem;
      padding: 0.16rem 0;
      color: var(--text-mid);
    }
    .flag-item.fail { color: var(--red); }
    .flag-item.ok   { color: var(--green); }
    .flag-item.warn { color: var(--amber); }

    .flag-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .fail .flag-dot { background: var(--red); }
    .ok   .flag-dot { background: var(--green); }
    .warn .flag-dot { background: var(--amber); }

    .val-gt-inner { padding: 0.5rem 1rem 0.55rem; }

    .gt-row { display: flex; flex-direction: column; padding: 0.18rem 0; gap: 0.08rem; }
    .gt-row .gt-label {
      font-size: 0.58rem;
      font-weight: 500;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .gt-row .gt-match   { color: var(--green); font-size: 0.72rem; display: flex; align-items: center; gap: 0.4rem; }
    .gt-row .gt-mismatch{ color: var(--red);   font-size: 0.72rem; display: flex; align-items: center; gap: 0.4rem; }
    .gt-row .gt-expected {
      font-size: 0.65rem;
      color: var(--text-dim);
      font-family: var(--mono);
      padding-left: 1rem;
    }

    .val-empty {
      padding: 2.5rem 1rem;
      text-align: center;
      color: var(--text-dim);
      font-size: 0.8rem;
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="header-brand">
      <div class="header-icon">ðŸ“„</div>
      <span class="header-title">Invoice Extraction</span>
    </div>
    <div class="header-sep"></div>
    <span class="header-tag">Group Operations Â· Demo</span>
  </div>

</header>

<div id="workspace">

  <!-- LEFT: Upload + PDF viewer -->
  <div id="pdf-column">
    <div id="upload-bar">
      <div id="drop-zone" onclick="document.getElementById('file-input').click()">
        <span>ðŸ“Ž</span>
        <span id="file-name">Drop PDF or click to select</span>
        <input type="file" id="file-input" accept=".pdf">
      </div>
      <div class="upload-actions">
        <select id="model-select">
          <option value="qwen3:4b">qwen3:4b</option>
          <option value="qwen3:8b">qwen3:8b</option>
          <option value="gemma3:4b">gemma3:4b</option>
          <option value="gemma3:12b">gemma3:12b</option>
        </select>
        <button class="btn" id="extract-btn" onclick="triggerExtract()" disabled>Extract</button>
        <span id="status"></span>
      </div>
    </div>
    <div id="pdf-panel">
      <div class="empty">
        <div class="icon">ðŸ“„</div>
        <div>PDF preview appears here</div>
      </div>
      <iframe id="pdf-embed"></iframe>
    </div>
  </div>

  <!-- MIDDLE: Extracted data -->
  <div id="data-panel" class="empty-state">
    <div>Upload an invoice to see extracted data</div>
  </div>

  <!-- RIGHT: Validation sidebar -->
  <div id="val-panel">
    <div class="val-main-header">Validation</div>
    <div class="val-empty">No data yet</div>
  </div>

</div>

<script>


  const API = "http://localhost:8000";
  const dropZone  = document.getElementById("drop-zone");
  const fileInput = document.getElementById("file-input");
  const fileName  = document.getElementById("file-name");
  const status    = document.getElementById("status");
  const pdfEmbed  = document.getElementById("pdf-embed");
  const pdfPanel  = document.getElementById("pdf-panel");
  const dataPanel = document.getElementById("data-panel");
  const valPanel  = document.getElementById("val-panel");

  dropZone.addEventListener("dragover",  e => { e.preventDefault(); dropZone.classList.add("drag-over"); });
  dropZone.addEventListener("dragleave", ()  => dropZone.classList.remove("drag-over"));
  dropZone.addEventListener("drop", e => { e.preventDefault(); dropZone.classList.remove("drag-over"); if (e.dataTransfer.files[0]) upload(e.dataTransfer.files[0]); });
  fileInput.addEventListener("change", () => {
    if (fileInput.files[0]) {
      fileName.textContent = fileInput.files[0].name;
      pdfPanel.querySelector(".empty").style.display = "none";
      pdfEmbed.src = URL.createObjectURL(fileInput.files[0]);
      pdfEmbed.style.display = "block";
      document.getElementById("extract-btn").disabled = false;
      status.textContent = "";
    }
  });

  function triggerExtract() { if (fileInput.files[0]) upload(fileInput.files[0]); }

  function v(x)   { return (x != null && x !== "") ? x : "â€”"; }
  function vDate(x) {
    if (x == null || x === "") return "â€”";
    const m = String(x).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m ? `${m[3]}.${m[2]}.${m[1]}` : x;
  }
  function eur(x) { return x != null ? `â‚¬\u00a0${x.toFixed(2)}` : "â€”"; }

  function scoreColor(s) {
    if (s >= 0.9) return "var(--green)";
    if (s >= 0.7) return "var(--amber)";
    return "var(--red)";
  }

  const requiredFlags = {
    invoice:  ["invoice_date_missing","invoice_number_missing","diagnosis_missing","treatments_missing","total_amount_missing"],
    doctor:   ["doctor_first_name_missing","doctor_last_name_missing","doctor_specialty_missing","doctor_practice_address_missing"],
    patient:  ["patient_first_name_missing","patient_last_name_missing","patient_date_of_birth_missing","patient_social_security_number_missing"],
    business: ["total_amount_invalid"],
  };

  const flagLabels = {
    invoice_date_missing:                   "Invoice date",
    invoice_number_missing:                 "Invoice number",
    diagnosis_missing:                      "Diagnosis",
    treatments_missing:                     "Treatments",
    total_amount_missing:                   "Total amount",
    doctor_first_name_missing:              "Doctor first name",
    doctor_last_name_missing:               "Doctor last name",
    doctor_specialty_missing:               "Doctor specialty",
    doctor_practice_address_missing:        "Practice address",
    patient_first_name_missing:             "Patient first name",
    patient_last_name_missing:              "Patient last name",
    patient_date_of_birth_missing:          "Date of birth",
    patient_social_security_number_missing: "SVNR",
    total_amount_invalid:                   "Total amount valid",
  };

  const completenessKeys = [...requiredFlags.invoice, ...requiredFlags.doctor, ...requiredFlags.patient];

  const flagToField = {
    invoice_date_missing:                   "invoice_date",
    invoice_number_missing:                 "invoice_number",
    diagnosis_missing:                      "diagnosis",
    total_amount_missing:                   "total_amount",
    doctor_first_name_missing:              "doctor_first_name",
    doctor_last_name_missing:               "doctor_last_name",
    doctor_specialty_missing:               "doctor_specialty",
    doctor_practice_address_missing:        "doctor_practice_address",
    patient_first_name_missing:             "patient_first_name",
    patient_last_name_missing:              "patient_last_name",
    patient_date_of_birth_missing:          "patient_date_of_birth",
    patient_social_security_number_missing: "patient_social_security_number",
  };

  function fc(flags, ...flagKeys) {
    const flagged  = flagKeys.some(k => flags[k]);
    const required = flagKeys.some(k => k in flagToField);
    if (flagged)  return "field flagged" + (required ? " required" : "");
    if (required) return "field required";
    return "field";
  }

  function totalAmountValid(flags) {
    return !flags["total_mismatch"] &&
           !flags["last_treatment_equals_sum_of_others"] &&
           !flags["last_treatment_looks_like_sum"];
  }

  function normalizeDate(val) {
    if (!val) return "";
    const m = String(val).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return `${m[3]}.${m[2]}.${m[1]}`;
    return String(val).toLowerCase().replace(/\s+/g, " ").trim();
  }

  function normalize(val) {
    if (val == null) return "";
    return String(val).toLowerCase().replace(/\s+/g, " ").trim();
  }

  function gtMatch(extracted, expected) {
    if (normalizeDate(extracted) === normalizeDate(expected)) return true;
    const exNum = parseFloat(extracted), expNum = parseFloat(expected);
    if (!isNaN(exNum) && !isNaN(expNum)) return Math.abs(exNum - expNum) < 0.01;
    return normalize(extracted) === normalize(expected);
  }

  const gtFields = [
    { label: "Invoice No.",  gt: "invoice_no",    ex: inv => inv.invoice_number },
    { label: "Date",         gt: "date",           ex: inv => inv.invoice_date },
    { label: "Doctor",       gt: "doctor",         ex: inv => inv.doctor ? `${inv.doctor.title||""} ${inv.doctor.first_name||""} ${inv.doctor.last_name||""}`.trim() : null },
    { label: "Specialty",    gt: "specialty",      ex: inv => inv.doctor?.specialty },
    { label: "Address",      gt: "doctor_address", ex: inv => inv.doctor?.practice_address },
    { label: "Patient",      gt: "patient",        ex: inv => inv.patient ? `${inv.patient.first_name||""} ${inv.patient.last_name||""}`.trim() : null },
    { label: "DOB",          gt: "patient_dob",    ex: inv => inv.patient?.date_of_birth },
    { label: "SVNR",         gt: "patient_svnr",   ex: inv => inv.patient?.social_security_number },
    { label: "Diagnosis",    gt: "diagnosis",      ex: inv => inv.diagnosis },
    { label: "Total",        gt: "total",          ex: inv => inv.total_amount },
  ];

  async function upload(file) {
    fileName.textContent = file.name;
    status.textContent = "Processingâ€¦";
    dataPanel.className = "";
    dataPanel.innerHTML = "<p style='padding:2rem;color:var(--text-dim);font-size:0.82rem'>Extracting dataâ€¦</p>";
    valPanel.innerHTML  = `<div class="val-main-header">Validation</div><div class="val-empty">Processingâ€¦</div>`;
    const form = new FormData();
    form.append("file", file);
    const model = document.getElementById("model-select").value;
    form.append("model", model);
    try {
      const res  = await fetch(`${API}/extract`, { method: "POST", body: form });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Unknown error");
      status.textContent = `âœ“  ${model}`;
      render(data);
    } catch (err) {
      status.textContent = `âœ— ${err.message}`;
    }
  }

  function render(data) {
    const inv     = data.invoice;
    const flags   = data.validation.flags;
    const gt      = data.ground_truth;
    const pdfType = data.pdf_type;
    const doc     = inv.doctor  || {};
    const pat     = inv.patient || {};
    const totalValid = totalAmountValid(flags);
    const pdfBadgeHtml = `<span class="pdf-type-badge badge-${pdfType}">${pdfType}</span>`;

    dataPanel.innerHTML = `
      <div class="card">
        <div class="card-header">
          <span class="card-title">Invoice</span>
          ${pdfBadgeHtml}
        </div>
        <div class="card-body">
          <div class="fields three">
            <div class="${fc(flags,'invoice_date_missing')}"><label>Date</label><span>${vDate(inv.invoice_date)}</span></div>
            <div class="${fc(flags,'invoice_number_missing')}"><label>Invoice No.</label><span>${v(inv.invoice_number)}</span></div>
            <div class="field"><label>Type</label><span>${v(inv.document_type)}</span></div>
            <div class="field"><label>Payment</label><span>${v(inv.payment_method)}</span></div>
            <div class="field" style="grid-column:span 2"><label>IBAN</label><span style="font-family:var(--mono);font-size:0.72rem">${v(inv.iban)}</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Doctor</span></div>
        <div class="card-body">
          <div class="fields">
            <div class="${fc(flags,'doctor_first_name_missing','doctor_last_name_missing')}"><label>Name</label><span>${v(doc.title)} ${v(doc.first_name)} ${v(doc.last_name)}</span></div>
            <div class="${fc(flags,'doctor_specialty_missing')}"><label>Specialty</label><span>${v(doc.specialty)}</span></div>
            <div class="${fc(flags,'doctor_practice_address_missing')}"><label>Address</label><span>${v(doc.practice_address)}</span></div>
            <div class="field"><label>Phone</label><span>${v(doc.phone)}</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Patient</span></div>
        <div class="card-body">
          <div class="fields">
            <div class="${fc(flags,'patient_first_name_missing','patient_last_name_missing')}"><label>Name</label><span>${v(pat.first_name)} ${v(pat.last_name)}</span></div>
            <div class="${fc(flags,'patient_date_of_birth_missing')}"><label>Date of Birth</label><span>${vDate(pat.date_of_birth)}</span></div>
            <div class="${fc(flags,'patient_social_security_number_missing')}"><label>SVNR</label><span style="font-family:var(--mono)">${v(pat.social_security_number)}</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Diagnosis & Treatments</span></div>
        <div class="card-body">
          <div class="${fc(flags,'diagnosis_missing')}">
            <label>Diagnosis</label>
            <span>${v(inv.diagnosis)}</span>
          </div>
          <div class="divider"></div>
          <label style="font-size:0.63rem;font-weight:500;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em">Treatments</label>
        </div>
        <div style="padding:0">
          <table>
            <thead><tr><th>Code</th><th>Description</th><th class="amount">Amount</th></tr></thead>
            <tbody>
              ${(inv.treatments||[]).map(t=>`
                <tr>
                  <td style="font-family:var(--mono);font-size:0.72rem">${v(t.code)}</td>
                  <td>${v(t.description)}</td>
                  <td class="amount">${eur(t.amount)}</td>
                </tr>`).join("")}
              <tr class="total-row"><td colspan="2">Total</td><td class="amount">${eur(inv.total_amount)}</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div><p class="req-legend"><span>*</span> Required fields for processing</p></div>
    `;

    // â”€â”€ Sidebar â”€â”€
    const compAllKeys = [...requiredFlags.invoice, ...requiredFlags.doctor, ...requiredFlags.patient];
    const compPassed2 = compAllKeys.filter(k => !flags[k]).length;
    const compPct = Math.round(compPassed2 / compAllKeys.length * 100);
    const compCol = scoreColor(compPassed2 / compAllKeys.length);

    const completionBlock = `
      <div class="val-section-block">
        <div class="val-subheading">
          <div class="val-subheading-row">
            <span class="val-subheading-title">Completion Rate</span>
            <span class="val-subheading-pct" style="color:${compCol}">${compPct}%</span>
          </div>
          <div class="val-section-bar">
            <div class="val-section-bar-fill" style="width:${compPct}%;background:${compCol}"></div>
          </div>
        </div>
        <div class="val-flags">
          ${compAllKeys.map(k => {
            const failed = flags[k];
            return `<div class="flag-item ${failed ? 'fail' : 'ok'}"><div class="flag-dot"></div><span>${flagLabels[k]}</span></div>`;
          }).join("")}
        </div>
      </div>`;

    const bizKeys = requiredFlags.business;
    const bizPassed = bizKeys.filter(k => k === "total_amount_invalid" ? totalValid : !flags[k]).length;
    const bizPct = Math.round(bizPassed / bizKeys.length * 100);
    const bizCol = scoreColor(bizPassed / bizKeys.length);

    const businessBlock = `
      <div class="val-section-block">
        <div class="val-subheading">
          <div class="val-subheading-row">
            <span class="val-subheading-title">Business Logic</span>
            <span class="val-subheading-pct" style="color:${bizCol}">${bizPct}%</span>
          </div>
          <div class="val-section-bar">
            <div class="val-section-bar-fill" style="width:${bizPct}%;background:${bizCol}"></div>
          </div>
        </div>
        <div class="val-flags">
          ${bizKeys.map(k => {
            const failed = k === "total_amount_invalid" ? !totalValid : flags[k];
            return `<div class="flag-item ${failed ? 'warn' : 'ok'}"><div class="flag-dot"></div><span>${flagLabels[k]}</span></div>`;
          }).join("")}
        </div>
      </div>`;

    let gtBlock = "";
    if (gt) {
      const rows = gtFields.map(f => {
        const extracted = f.ex(inv);
        const expected  = gt[f.gt];
        if (expected == null) return "";
        const match = gtMatch(extracted, expected);
        return `<div class="gt-row">
          <span class="gt-label">${f.label}</span>
          <span class="${match ? 'gt-match' : 'gt-mismatch'}">
            <div class="flag-dot" style="background:${match ? 'var(--green)' : 'var(--red)'};flex-shrink:0"></div>
            ${v(extracted)}
          </span>
          ${!match ? `<span class="gt-expected">â†³ ${expected}</span>` : ""}
        </div>`;
      }).filter(Boolean).join("");

      const gtPassed = gtFields.filter(f => gt[f.gt] != null && gtMatch(f.ex(inv), gt[f.gt])).length;
      const gtTotal  = gtFields.filter(f => gt[f.gt] != null).length;
      const gtPct    = Math.round(gtPassed / gtTotal * 100);
      const gtColor  = scoreColor(gtPassed / gtTotal);

      gtBlock = `
        <div class="val-section-block">
          <div class="val-subheading">
            <div class="val-subheading-row">
              <span class="val-subheading-title">Ground Truth</span>
              <span class="val-subheading-pct" style="color:${gtColor}">${gtPct}%</span>
            </div>
            <div class="val-section-bar">
              <div class="val-section-bar-fill" style="width:${gtPct}%;background:${gtColor}"></div>
            </div>
          </div>
          <div class="val-gt-inner">${rows}</div>
        </div>`;
    }

    valPanel.innerHTML = `
      <div class="val-main-header">Validation</div>
      ${completionBlock}
      ${businessBlock}
      ${gtBlock}
    `;
  }
</script>
</body>
</html>