<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Invoice Extraction Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue:   #003366;
      --blue-lt:#e8eef6;
      --green:  #1a7a4a;
      --amber:  #b45309;
      --red:    #c0392b;
      --grey:   #64748b;
      --border: #e2e8f0;
      --bg:     #f8fafc;
      --card:   #ffffff;
      --text:   #0f172a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "DM Sans", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header { background: var(--blue); color: white; padding: 0 1.5rem; height: 52px; display: flex; align-items: center; flex-shrink: 0; }
    .header-left { display: flex; align-items: center; gap: 0.75rem; }
    .header-logo { font-size: 1rem; font-weight: 600; letter-spacing: -0.02em; }
    .header-sep  { width: 1px; height: 18px; background: rgba(255,255,255,0.25); }
    .header-sub  { font-size: 0.8rem; opacity: 0.6; font-weight: 300; }

    /* ‚îÄ‚îÄ Main 3-column layout ‚îÄ‚îÄ */
    #workspace { flex: 1; display: grid; grid-template-columns: 1fr 1.6fr 280px; overflow: hidden; }

    /* ‚îÄ‚îÄ PDF column (left) ‚Äì has upload bar on top ‚îÄ‚îÄ */
    #pdf-column { display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow: hidden; }

    #upload-bar {
      background: white;
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 0.75rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    #drop-zone {
      flex: 1;
      min-width: 0;
      border: 1.5px dashed var(--border);
      border-radius: 7px;
      padding: 0.4rem 0.6rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      font-size: 0.82rem;
      color: var(--grey);
    }
    #drop-zone.drag-over { border-color: var(--blue); background: var(--blue-lt); }
    #drop-zone input { display: none; }
    #file-name { font-family: "DM Mono", monospace; font-size: 0.75rem; color: var(--text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }

    .upload-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }

    .btn { padding: 0.4rem 0.9rem; background: var(--blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.78rem; font-family: "DM Sans", sans-serif; font-weight: 500; white-space: nowrap; transition: background 0.15s; }
    .btn:hover { background: #00254d; }
    #status { font-size: 0.75rem; color: var(--grey); white-space: nowrap; }

    /* ‚îÄ‚îÄ PDF viewer ‚îÄ‚îÄ */
    #pdf-panel { flex: 1; background: #e8eef6; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    #pdf-panel .empty { color: var(--grey); font-size: 0.85rem; text-align: center; }
    #pdf-panel .empty .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    #pdf-embed { width: 100%; height: 100%; border: none; display: none; }

    /* ‚îÄ‚îÄ Data panel (middle) ‚îÄ‚îÄ */
    #data-panel { overflow-y: auto; padding: 1.25rem; display: flex; flex-direction: column; gap: 0.85rem; }
    #data-panel.empty-state { align-items: center; justify-content: center; color: var(--grey); font-size: 0.85rem; }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .card-header { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0.9rem; border-bottom: 1px solid var(--border); background: #fafbfc; gap: 0.5rem; }
    .card-header .pdf-type-badge { margin-left: auto; }
    .card-header-left { display: flex; align-items: center; gap: 0.5rem; }
    .card-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--grey); }
    .pdf-type-badge { font-family: "DM Mono", monospace; font-size: 0.68rem; font-weight: 500; padding: 0.15rem 0.5rem; border-radius: 10px; }
    .badge-digital     { background: #e0f2e9; color: var(--green); }
    .badge-scan        { background: #fff3e0; color: var(--amber); }
    .badge-handwritten { background: #f3e8ff; color: #7c3aed; }
    .mini-score { font-family: "DM Mono", monospace; font-size: 0.72rem; font-weight: 500; padding: 0.15rem 0.5rem; border-radius: 10px; }
    .card-body { padding: 0.75rem 0.9rem; }
    .fields { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1.2rem; }
    .fields.three { grid-template-columns: 1fr 1fr 1fr; }
    .field label { display: block; font-size: 0.68rem; color: var(--grey); margin-bottom: 0.1rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .field span { font-size: 0.85rem; font-weight: 500; }
    .field.required label::after { content: " *"; color: var(--amber); font-weight: 700; }
    .field.flagged span { color: var(--red); }
    .field.flagged label { color: var(--red); }
    .field.flagged label::after { color: var(--red); }
    .divider { height: 1px; background: var(--border); margin: 0.6rem 0; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th { padding: 0.4rem 0.6rem; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--grey); border-bottom: 1px solid var(--border); text-align: left; }
    td { padding: 0.4rem 0.6rem; border-bottom: 1px solid #f1f5f9; }
    tr:last-child td { border-bottom: none; }
    .total-row td { font-weight: 600; border-top: 1.5px solid var(--border); background: #fafbfc; }
    .amount { text-align: right; font-family: "DM Mono", monospace; font-size: 0.8rem; }
    .req-legend { font-size: 0.68rem; color: var(--grey); }
    .req-legend span { color: var(--amber); font-weight: 700; }

    /* ‚îÄ‚îÄ Validation sidebar ‚îÄ‚îÄ */
    #val-panel { border-left: 1px solid var(--border); background: var(--card); display: flex; flex-direction: column; overflow-y: auto; }
    .val-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--grey); background: #fafbfc; flex-shrink: 0; }
    .val-score-block { padding: 0.85rem 1rem; border-bottom: 1px solid var(--border); }
    .val-score-row { display: flex; align-items: baseline; justify-content: space-between; }
    .val-score-num { font-size: 1.8rem; font-weight: 600; font-family: "DM Mono", monospace; line-height: 1; }
    .val-score-label { font-size: 0.68rem; color: var(--grey); text-transform: uppercase; letter-spacing: 0.06em; }
    .score-bar { height: 4px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 0.5rem; }
    .score-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    .val-section { padding: 0.65rem 1rem 0.5rem; border-bottom: 1px solid var(--border); }
    .val-section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.4rem; }
    .val-section-title { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: var(--grey); }
    .flag-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; padding: 0.18rem 0; }
    .flag-item.fail { color: var(--red); }
    .flag-item.ok   { color: var(--green); }
    .flag-item.warn { color: var(--amber); }
    .flag-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .fail .flag-dot { background: var(--red); }
    .ok   .flag-dot { background: var(--green); }
    .warn .flag-dot { background: var(--amber); }
    .val-empty { padding: 2rem 1rem; text-align: center; color: var(--grey); font-size: 0.82rem; }
    .gt-row { display: flex; flex-direction: column; padding: 0.2rem 0; font-size: 0.75rem; gap: 0.1rem; }
    .gt-row .gt-label { font-size: 0.65rem; color: var(--grey); text-transform: uppercase; letter-spacing: 0.04em; }
    .gt-row .gt-match { color: var(--green); }
    .gt-row .gt-mismatch { color: var(--red); }
    .gt-row .gt-expected { font-size: 0.7rem; color: var(--grey); font-family: "DM Mono", monospace; }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <span class="header-logo">Invoice Extraction</span>
    <div class="header-sep"></div>
    <span class="header-sub">Demo Dashboard for Group Operations</span>
  </div>
</header>

<div id="workspace">

  <!-- LEFT: Upload + PDF viewer -->
  <div id="pdf-column">
    <div id="upload-bar">
      <div id="drop-zone" onclick="document.getElementById('file-input').click()">
        <span>üìé</span>
        <span id="file-name">Drop PDF or click to select</span>
        <input type="file" id="file-input" accept=".pdf">
      </div>
      <div class="upload-actions">
        <button class="btn" onclick="document.getElementById('file-input').click()">Upload PDF</button>
        <span id="status"></span>
      </div>
    </div>
    <div id="pdf-panel">
      <div class="empty"><div class="icon">üìÑ</div><div>PDF preview appears here</div></div>
      <iframe id="pdf-embed"></iframe>
    </div>
  </div>

  <!-- MIDDLE: Extracted data -->
  <div id="data-panel" class="empty-state">
    <div>Upload an invoice to see extracted data</div>
  </div>

  <!-- RIGHT: Validation sidebar -->
  <div id="val-panel">
    <div class="val-header">Validation</div>
    <div class="val-empty">No data yet</div>
  </div>

</div>

<script>
  const API = "http://localhost:8000";
  const dropZone  = document.getElementById("drop-zone");
  const fileInput = document.getElementById("file-input");
  const fileName  = document.getElementById("file-name");
  const status    = document.getElementById("status");
  const pdfEmbed  = document.getElementById("pdf-embed");
  const pdfPanel  = document.getElementById("pdf-panel");
  const dataPanel = document.getElementById("data-panel");
  const valPanel  = document.getElementById("val-panel");

  dropZone.addEventListener("dragover",  e => { e.preventDefault(); dropZone.classList.add("drag-over"); });
  dropZone.addEventListener("dragleave", ()  => dropZone.classList.remove("drag-over"));
  dropZone.addEventListener("drop", e => { e.preventDefault(); dropZone.classList.remove("drag-over"); if (e.dataTransfer.files[0]) upload(e.dataTransfer.files[0]); });
  fileInput.addEventListener("change", () => { if (fileInput.files[0]) upload(fileInput.files[0]); });

  function v(x)   { return (x != null && x !== "") ? x : "‚Äî"; }
  function eur(x) { return x != null ? `‚Ç¨ ${x.toFixed(2)}` : "‚Äî"; }

  function scoreColor(s) {
    if (s >= 0.9) return "var(--green)";
    if (s >= 0.7) return "var(--amber)";
    return "var(--red)";
  }

  const requiredFlags = {
    invoice:  ["invoice_date_missing","invoice_number_missing","diagnosis_missing","treatments_missing","total_amount_missing"],
    doctor:   ["doctor_first_name_missing","doctor_last_name_missing","doctor_specialty_missing","doctor_practice_address_missing"],
    patient:  ["patient_first_name_missing","patient_last_name_missing","patient_date_of_birth_missing","patient_social_security_number_missing"],
    business: ["total_amount_invalid"],
  };

  const flagLabels = {
    invoice_date_missing:                   "Invoice date",
    invoice_number_missing:                 "Invoice number",
    diagnosis_missing:                      "Diagnosis",
    treatments_missing:                     "Treatments",
    total_amount_missing:                   "Total amount",
    doctor_first_name_missing:              "Doctor first name",
    doctor_last_name_missing:               "Doctor last name",
    doctor_specialty_missing:               "Doctor specialty",
    doctor_practice_address_missing:        "Practice address",
    patient_first_name_missing:             "Patient first name",
    patient_last_name_missing:              "Patient last name",
    patient_date_of_birth_missing:          "Date of birth",
    patient_social_security_number_missing: "SVNR",
    total_amount_invalid:                   "Total amount valid",
  };

  const completenessKeys = [...requiredFlags.invoice, ...requiredFlags.doctor, ...requiredFlags.patient];

  const flagToField = {
    invoice_date_missing:                   "invoice_date",
    invoice_number_missing:                 "invoice_number",
    diagnosis_missing:                      "diagnosis",
    total_amount_missing:                   "total_amount",
    doctor_first_name_missing:              "doctor_first_name",
    doctor_last_name_missing:               "doctor_last_name",
    doctor_specialty_missing:               "doctor_specialty",
    doctor_practice_address_missing:        "doctor_practice_address",
    patient_first_name_missing:             "patient_first_name",
    patient_last_name_missing:              "patient_last_name",
    patient_date_of_birth_missing:          "patient_date_of_birth",
    patient_social_security_number_missing: "patient_social_security_number",
  };

  function fc(flags, ...flagKeys) {
    const flagged  = flagKeys.some(k => flags[k]);
    const required = flagKeys.some(k => k in flagToField);
    if (flagged)  return "field flagged" + (required ? " required" : "");
    if (required) return "field required";
    return "field";
  }

  // Compute combined total amount valid flag from the three business logic flags
  function totalAmountValid(flags) {
    return !flags["total_mismatch"] &&
           !flags["last_treatment_equals_sum_of_others"] &&
           !flags["last_treatment_looks_like_sum"];
  }

  function normalizeDate(val) {
    if (!val) return "";
    const m = String(val).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return `${m[3]}.${m[2]}.${m[1]}`;
    return String(val).toLowerCase().replace(/\s+/g, " ").trim();
  }

  function normalize(val) {
    if (val == null) return "";
    return String(val).toLowerCase().replace(/\s+/g, " ").trim();
  }

  function gtMatch(extracted, expected) {
    if (normalizeDate(extracted) === normalizeDate(expected)) return true;
    const exNum = parseFloat(extracted), expNum = parseFloat(expected);
    if (!isNaN(exNum) && !isNaN(expNum)) return Math.abs(exNum - expNum) < 0.01;
    return normalize(extracted) === normalize(expected);
  }

  const gtFields = [
    { label: "Invoice No.",  gt: "invoice_no",    ex: inv => inv.invoice_number },
    { label: "Date",         gt: "date",           ex: inv => inv.invoice_date },
    { label: "Doctor",       gt: "doctor",         ex: inv => inv.doctor ? `${inv.doctor.title||""} ${inv.doctor.first_name||""} ${inv.doctor.last_name||""}`.trim() : null },
    { label: "Specialty",    gt: "specialty",      ex: inv => inv.doctor?.specialty },
    { label: "Address",      gt: "doctor_address", ex: inv => inv.doctor?.practice_address },
    { label: "Patient",      gt: "patient",        ex: inv => inv.patient ? `${inv.patient.first_name||""} ${inv.patient.last_name||""}`.trim() : null },
    { label: "DOB",          gt: "patient_dob",    ex: inv => inv.patient?.date_of_birth },
    { label: "SVNR",         gt: "patient_svnr",   ex: inv => inv.patient?.social_security_number },
    { label: "Diagnosis",    gt: "diagnosis",      ex: inv => inv.diagnosis },
    { label: "Total",        gt: "total",          ex: inv => inv.total_amount },
  ];

  async function upload(file) {
    fileName.textContent = file.name;
    status.textContent = "‚è≥ Processing‚Ä¶";
    dataPanel.className = "";
    dataPanel.innerHTML = "<p style='padding:2rem;color:var(--grey);font-size:0.85rem'>Extracting data‚Ä¶</p>";
    valPanel.innerHTML  = "<div class='val-header'>Validation</div><div class='val-empty'>Processing‚Ä¶</div>";
    pdfPanel.querySelector(".empty").style.display = "none";
    pdfEmbed.src = URL.createObjectURL(file);
    pdfEmbed.style.display = "block";

    const form = new FormData();
    form.append("file", file);
    try {
      const res  = await fetch(`${API}/extract`, { method: "POST", body: form });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Unknown error");
      status.textContent = "‚úÖ Done";
      render(data);
    } catch (err) {
      status.textContent = `‚ùå ${err.message}`;
    }
  }

  function render(data) {
    const inv     = data.invoice;
    const flags   = data.validation.flags;
    const gt      = data.ground_truth;
    const pdfType = data.pdf_type;
    const doc     = inv.doctor  || {};
    const pat     = inv.patient || {};

    const compPassed = completenessKeys.filter(k => !flags[k]).length;
    const compScore  = compPassed / completenessKeys.length;
    const compColor  = scoreColor(compScore);
    const totalValid = totalAmountValid(flags);

    const pdfBadgeHtml = `<span class="pdf-type-badge badge-${pdfType}">${pdfType}</span>`;

    dataPanel.innerHTML = `

      <div class="card">
        <div class="card-header">
          <span class="card-title">Invoice</span>
          ${pdfBadgeHtml}
        </div>
        <div class="card-body">
          <div class="fields three">
            <div class="${fc(flags,'invoice_date_missing')}"><label>Date</label><span>${v(inv.invoice_date)}</span></div>
            <div class="${fc(flags,'invoice_number_missing')}"><label>Invoice No.</label><span>${v(inv.invoice_number)}</span></div>
            <div class="field"><label>Type</label><span>${v(inv.document_type)}</span></div>
            <div class="field"><label>Payment</label><span>${v(inv.payment_method)}</span></div>
            <div class="field" style="grid-column:span 2"><label>IBAN</label><span style="font-family:'DM Mono',monospace;font-size:0.75rem">${v(inv.iban)}</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Doctor</span></div>
        <div class="card-body">
          <div class="fields">
            <div class="${fc(flags,'doctor_first_name_missing','doctor_last_name_missing')}"><label>Name</label><span>${v(doc.title)} ${v(doc.first_name)} ${v(doc.last_name)}</span></div>
            <div class="${fc(flags,'doctor_specialty_missing')}"><label>Specialty</label><span>${v(doc.specialty)}</span></div>
            <div class="${fc(flags,'doctor_practice_address_missing')}"><label>Address</label><span>${v(doc.practice_address)}</span></div>
            <div class="field"><label>Phone</label><span>${v(doc.phone)}</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Patient</span></div>
        <div class="card-body">
          <div class="fields">
            <div class="${fc(flags,'patient_first_name_missing','patient_last_name_missing')}"><label>Name</label><span>${v(pat.first_name)} ${v(pat.last_name)}</span></div>
            <div class="${fc(flags,'patient_date_of_birth_missing')}"><label>Date of Birth</label><span>${v(pat.date_of_birth)}</span></div>
            <div class="${fc(flags,'patient_social_security_number_missing')}"><label>SVNR</label><span style="font-family:'DM Mono',monospace">${v(pat.social_security_number)}</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="card-title">Diagnosis & Treatments</span></div>
        <div class="card-body">
          <div class="${fc(flags,'diagnosis_missing')}">
            <label>Diagnosis</label>
            <span>${v(inv.diagnosis)}</span>
          </div>
          <div class="divider"></div>
          <label style="font-size:0.68rem;color:var(--grey);text-transform:uppercase;letter-spacing:0.04em">Treatments</label><span>${v(inv.treatments)}</span>
        </div>
        <div style="padding:0">
          <table>
            <thead><tr><th>Code</th><th>Description</th><th class="amount">Amount</th></tr></thead>
            <tbody>
              ${(inv.treatments||[]).map(t=>`
                <tr>
                  <td style="font-family:'DM Mono',monospace;font-size:0.78rem;color:var(--grey)">${v(t.code)}</td>
                  <td>${v(t.description)}</td>
                  <td class="amount">${eur(t.amount)}</td>
                </tr>`).join("")}
              <tr class="total-row"><td colspan="2">Total</td><td class="amount">${eur(inv.total_amount)}</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <p class="req-legend"><span>*</span> Required fields for processing</p>
    `;

    // ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ
    function valSection(title, group) {
      const keys   = requiredFlags[group];
      const passed = keys.filter(k => {
        // for business, use our computed flag
        if (k === "total_amount_invalid") return totalValid;
        return !flags[k];
      }).length;
      const c     = scoreColor(passed / keys.length);
      const isBiz = group === "business";
      return `<div class="val-section">
        <div class="val-section-header">
          <span class="val-section-title">${title}</span>
          <span class="mini-score" style="background:${c}22;color:${c}">${passed}/${keys.length}</span>
        </div>
        ${keys.map(k => {
          const failed = k === "total_amount_invalid" ? !totalValid : flags[k];
          const cls = isBiz && failed ? "warn" : failed ? "fail" : "ok";
          return `<div class="flag-item ${cls}"><div class="flag-dot"></div><span>${flagLabels[k]}</span></div>`;
        }).join("")}
      </div>`;
    }

    let gtHtml = "";
    if (gt) {
      const rows = gtFields.map(f => {
        const extracted = f.ex(inv);
        const expected  = gt[f.gt];
        if (expected == null) return "";
        const match = gtMatch(extracted, expected);
        return `<div class="gt-row">
          <span class="gt-label">${f.label}</span>
          <span class="${match ? 'gt-match' : 'gt-mismatch'}">${match ? "‚úÖ " : "‚ùå "}${v(extracted)}</span>
          ${!match ? `<span class="gt-expected">expected: ${expected}</span>` : ""}
        </div>`;
      }).filter(Boolean).join("");

      const gtPassed = gtFields.filter(f => gt[f.gt] != null && gtMatch(f.ex(inv), gt[f.gt])).length;
      const gtTotal  = gtFields.filter(f => gt[f.gt] != null).length;
      const gtColor  = scoreColor(gtPassed / gtTotal);

      gtHtml = `
        <div class="val-score-block" style="padding-top:0.65rem;padding-bottom:0.65rem">
          <div class="val-score-row">
            <span class="val-score-label">Ground Truth</span>
            <span class="mini-score" style="background:${gtColor}22;color:${gtColor}">${gtPassed}/${gtTotal}</span>
          </div>
        </div>
        <div class="val-section">
          <div class="val-section-title" style="margin-bottom:0.5rem">Field Accuracy</div>
          ${rows}
        </div>`;
    }

    valPanel.innerHTML = `
      <div class="val-header">Validation</div>
      <div class="val-score-block">
        <div class="val-score-row">
          <div class="val-score-num" style="color:${compColor}">${Math.round(compScore*100)}%</div>
        </div>
        <div class="val-score-label" style="margin-top:0.25rem">Completion Rate</div>
        <div class="score-bar"><div class="score-fill" style="width:${compScore*100}%;background:${compColor}"></div></div>
      </div>
      ${valSection("Invoice",  "invoice")}
      ${valSection("Doctor",   "doctor")}
      ${valSection("Patient",  "patient")}
      ${valSection("Amount Validation", "business")}
      ${gtHtml}
    `;
  }
</script>
</body>
</html>